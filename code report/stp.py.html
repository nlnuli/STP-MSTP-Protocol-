<html>
<head>
<title>stp.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
stp.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">time</span>
<span class="s0">import </span><span class="s1">networkx </span><span class="s0">as </span><span class="s1">nx</span>
<span class="s0">import </span><span class="s1">matplotlib.pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">import </span><span class="s1">PIL</span>
<span class="s1">fp = open(</span><span class="s2">'/Users/yewen/Desktop/2023毕业设计/code/STP/data_test/print.txt'</span><span class="s0">,</span><span class="s2">&quot;w&quot;</span><span class="s1">)</span>
<span class="s0">import </span><span class="s1">matplotlib</span>
<span class="s1">g = nx.Graph() </span><span class="s3"># 创建拓扑图</span>
<span class="s1">G = nx.Graph()</span>
<span class="s3">#增加节点 节点是端口</span>
<span class="s3"># 增加</span>

<span class="s3">##建立交换机类</span>
<span class="s1">print(</span><span class="s2">&quot;-------添加节点中--------&quot;</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s0">class </span><span class="s1">Switch:</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">port_list</span><span class="s0">, </span><span class="s1">number</span><span class="s0">, </span><span class="s1">switch_name</span><span class="s0">, </span><span class="s1">pc_mac = </span><span class="s4">0</span><span class="s1">):</span>
        <span class="s1">self.port = []</span>
        <span class="s1">self.switch_name = switch_name</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">port_list:</span>
            <span class="s1">self.port.append(i)</span>
        <span class="s1">self.number = number </span><span class="s3">## switch bid</span>
        <span class="s1">self.pc_mac = pc_mac</span>

<span class="s0">class </span><span class="s1">fwd_table:</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">switch_name):</span>
        <span class="s1">self.name = switch_name</span>
        <span class="s1">self.fwd_index = list()</span>

<span class="s1">file_path = </span><span class="s2">'/Users/yewen/Desktop/2023毕业设计/code/STP/data_test/stp.xls'</span>
<span class="s1">raw_data = pd.read_excel(file_path</span><span class="s0">, </span><span class="s1">header=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">sheet_name=</span><span class="s2">'switch'</span><span class="s1">)</span>
<span class="s1">data = raw_data.values</span>
<span class="s1">switch_list = list()</span>
<span class="s3">## 读取execl switch信息</span>
<span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(data.shape[</span><span class="s4">0</span><span class="s1">]) :</span>
    <span class="s1">switch_data = data[i]</span>
    <span class="s1">str1 = str(switch_data[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">list1 = str1.split(</span><span class="s2">','</span><span class="s1">)</span>
    <span class="s1">list1 = [int(i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">list1]</span>
    <span class="s1">print(list1</span><span class="s0">, </span><span class="s1">file = fp)</span>
    <span class="s1">switch_list.append(Switch(list1</span><span class="s0">, </span><span class="s1">switch_data[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">switch_data[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span><span class="s1">switch_data[</span><span class="s4">3</span><span class="s1">]))</span>



<span class="s2">''' 
##输入节点 之后进行修改 
list_Node = input() 
g.add_nodes_from(list_Node) 
'''</span>
<span class="s3"># 对于4节点的拓扑图 8 个节点 初始化BPDU 端口初始化</span>
<span class="s1">raw_data = pd.read_excel(file_path</span><span class="s0">, </span><span class="s1">header=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">sheet_name=</span><span class="s2">'port'</span><span class="s1">)</span>
<span class="s1">data = raw_data.values</span>
<span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(data.shape[</span><span class="s4">0</span><span class="s1">]) :</span>
    <span class="s1">port_data = data[i]</span>
    <span class="s1">g.add_node(port_data[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span><span class="s1">RPC = </span><span class="s4">0</span><span class="s0">,</span><span class="s1">SBID = </span><span class="s4">0</span><span class="s0">, </span><span class="s1">BID = </span><span class="s4">0</span><span class="s0">, </span><span class="s1">SPID = port_data[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span><span class="s1">Port_status = </span><span class="s2">'None'</span><span class="s1">)</span>
<span class="s3">##数据维修</span>
<span class="s0">for </span><span class="s1">switch </span><span class="s0">in </span><span class="s1">switch_list:</span>
    <span class="s1">port_list = switch.port</span>
    <span class="s0">for </span><span class="s1">port </span><span class="s0">in </span><span class="s1">port_list:</span>
        <span class="s1">g.nodes[port][</span><span class="s2">'SBID'</span><span class="s1">] = switch.number</span>
        <span class="s1">g.nodes[port][</span><span class="s2">'BID'</span><span class="s1">] = switch.number</span>
    <span class="s1">g.add_node(switch.switch_name</span><span class="s0">,</span><span class="s1">RPC = -</span><span class="s4">1</span><span class="s0">, </span><span class="s1">SBID = -</span><span class="s4">1</span><span class="s0">, </span><span class="s1">BID = switch.number</span><span class="s0">, </span><span class="s1">SPID = -</span><span class="s4">1</span><span class="s0">, </span><span class="s1">Port_status = </span><span class="s2">'Switch'</span><span class="s1">)</span>


<span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">g.nodes(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s1">print(node</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s3">#初始化边</span>
<span class="s0">for </span><span class="s1">switch </span><span class="s0">in </span><span class="s1">switch_list :</span>
    <span class="s3">#根据路由器来添加节点</span>
    <span class="s1">port_list = switch.port</span>
    <span class="s1">switchname = switch.switch_name</span>
    <span class="s0">for </span><span class="s1">port </span><span class="s0">in </span><span class="s1">port_list :</span>
        <span class="s1">g.add_weighted_edges_from([(port</span><span class="s0">,</span><span class="s1">switchname</span><span class="s0">,</span><span class="s4">0</span><span class="s1">)])</span>

<span class="s3">##############</span>

<span class="s1">raw_data = pd.read_excel(file_path</span><span class="s0">, </span><span class="s1">header=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">sheet_name=</span><span class="s2">'edge'</span><span class="s1">)</span>
<span class="s1">data = raw_data.values</span>

<span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(data.shape[</span><span class="s4">0</span><span class="s1">]) :</span>
    <span class="s1">list1 = list(data[i])</span>
    <span class="s1">g.add_weighted_edges_from([(list1[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span><span class="s1">list1[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span><span class="s1">list1[</span><span class="s4">2</span><span class="s1">])])</span>
<span class="s0">for </span><span class="s1">edge </span><span class="s0">in </span><span class="s1">g.edges(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s0">if </span><span class="s1">edge[</span><span class="s4">2</span><span class="s1">][</span><span class="s2">'weight'</span><span class="s1">] != </span><span class="s4">0</span><span class="s1">:</span>
     <span class="s1">print(edge</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s3">##############</span>

<span class="s1">print(</span><span class="s2">'----节点添加完成'</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s3">#选举根桥</span>
<span class="s3"># 选择根节点找到对应的根可能对应多个端口</span>
<span class="s1">print(</span><span class="s2">'----选举根桥-----'</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s1">time.sleep(</span><span class="s4">0.5</span><span class="s1">)</span>
<span class="s1">rootNode = </span><span class="s4">9999 </span><span class="s3">#max</span>
<span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">g.nodes(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s0">if </span><span class="s1">rootNode &gt; node[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'BID'</span><span class="s1">] :</span>
        <span class="s1">rootNode = node[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'BID'</span><span class="s1">]</span>
<span class="s1">print(</span><span class="s2">&quot;THE rootNode  BID is {}&quot;</span><span class="s1">.format(rootNode)</span><span class="s0">, </span><span class="s1">file = fp)</span>


<span class="s3">##此时直接根据这个来选择BID</span>



<span class="s3">#更新配置的BPDU</span>
<span class="s1">print(</span><span class="s2">&quot;------更新配置的BPDU------&quot;</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s1">time.sleep(</span><span class="s4">0.5</span><span class="s1">)</span>
<span class="s3">#更改BPDU状态</span>
<span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">g.nodes(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s0">if </span><span class="s1">node[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'BID'</span><span class="s1">] == rootNode </span><span class="s0">and </span><span class="s1">node[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'Port_status'</span><span class="s1">] != </span><span class="s2">'Switch'</span><span class="s1">:</span>
        <span class="s1">g.nodes[node[</span><span class="s4">0</span><span class="s1">]][</span><span class="s2">'Port_status'</span><span class="s1">] = </span><span class="s2">&quot;Designated&quot;</span>
    <span class="s1">node[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'BID'</span><span class="s1">] = rootNode</span>
    <span class="s1">print(node</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s0">else</span><span class="s1">:</span>
    <span class="s1">print(</span><span class="s2">&quot;the alter BID action is over&quot;</span><span class="s0">, </span><span class="s1">file = fp)</span>






<span class="s1">print(</span><span class="s2">&quot;---------寻找root Port------计算RPC-----&quot;</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s1">time.sleep(</span><span class="s4">0.5</span><span class="s1">)</span>
<span class="s3">#寻找根端口计算RPC</span>
<span class="s3">#内置算法</span>
<span class="s0">def </span><span class="s1">rpc(node1</span><span class="s0">, </span><span class="s1">node2):</span>
    <span class="s3">#断开对应的端口计算</span>
    <span class="s1">p = nx.shortest_path_length(g</span><span class="s0">,</span><span class="s1">source = node1</span><span class="s0">, </span><span class="s1">target = node2</span><span class="s0">, </span><span class="s1">weight = </span><span class="s2">'weight' </span><span class="s1">)</span>
    <span class="s0">return </span><span class="s1">p</span>

<span class="s0">def </span><span class="s1">path(node1</span><span class="s0">,</span><span class="s1">node2):</span>
    <span class="s1">p = nx.shortest_path(g</span><span class="s0">, </span><span class="s1">source = node1</span><span class="s0">, </span><span class="s1">target = node2</span><span class="s0">, </span><span class="s1">weight = </span><span class="s2">'weight'</span><span class="s1">)</span>
    <span class="s0">return </span><span class="s1">p</span>

<span class="s0">def </span><span class="s1">find_bid(port1): </span><span class="s3">#参数为端口</span>
    <span class="s0">for </span><span class="s1">switch </span><span class="s0">in </span><span class="s1">switch_list:</span>
        <span class="s0">if </span><span class="s1">port1 </span><span class="s0">in </span><span class="s1">switch.port:</span>
            <span class="s0">return </span><span class="s1">switch.number</span>

<span class="s3">#更新rpc 与配置 BPDU</span>
<span class="s3">#根节点为BID</span>
<span class="s1">target_switch = Switch([]</span><span class="s0">,</span><span class="s1">-</span><span class="s4">1</span><span class="s0">,</span><span class="s2">'-1'</span><span class="s1">)</span>
<span class="s0">for </span><span class="s1">switch </span><span class="s0">in </span><span class="s1">switch_list:</span>
    <span class="s3">#找到对应的switch</span>
    <span class="s0">if </span><span class="s1">switch.number == rootNode:</span>
        <span class="s1">target_switch = switch</span>
        <span class="s0">break</span>


<span class="s0">for </span><span class="s1">switch </span><span class="s0">in </span><span class="s1">switch_list: </span><span class="s3">#更改 定义端口数量</span>
    <span class="s0">if </span><span class="s1">switch == target_switch:</span>
        <span class="s0">continue</span><span class="s1">;</span>
    <span class="s3">#交换机 存储着BID 对应端口的PID 我们需要对每个端口计算到BP的距离</span>
    <span class="s1">port_list = switch.port</span>
    <span class="s1">switchname = switch.switch_name</span>
    <span class="s3">#去掉端口的边</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">port_list:</span>
        <span class="s0">if </span><span class="s1">g.has_edge(i</span><span class="s0">,</span><span class="s1">switchname):</span>
            <span class="s1">g.remove_edge(i</span><span class="s0">,</span><span class="s1">switchname)</span>

    <span class="s3">#更新完成计算rpc</span>
    <span class="s3">#对port_list 计算</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">port_list:</span>
        <span class="s1">min = </span><span class="s4">999999</span>
        <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">target_switch.port:</span>
                <span class="s1">p1 = rpc(i</span><span class="s0">,</span><span class="s1">j)</span>
                <span class="s0">if </span><span class="s1">min &gt; p1:</span>
                    <span class="s1">min = p1</span>
                    <span class="s3">#更优秀</span>
                    <span class="s1">short_path = path(i</span><span class="s0">,</span><span class="s1">j)</span>
                    <span class="s1">sbid = find_bid(short_path[</span><span class="s4">1</span><span class="s1">])</span>

        <span class="s3">#计算出来后需要修改</span>
        <span class="s1">g.nodes[i][</span><span class="s2">'RPC'</span><span class="s1">] = min</span>
        <span class="s1">g.nodes[i][</span><span class="s2">'SPID'</span><span class="s1">] = short_path[</span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">g.nodes[i][</span><span class="s2">'SBID'</span><span class="s1">] = sbid</span>
    <span class="s3">#恢复线路</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">port_list:</span>
        <span class="s0">if not </span><span class="s1">g.has_edge(i</span><span class="s0">,</span><span class="s1">switchname) :</span>
                     <span class="s1">g.add_weighted_edges_from([(i</span><span class="s0">,</span><span class="s1">switchname</span><span class="s0">,</span><span class="s4">0</span><span class="s1">)])</span>

<span class="s0">for </span><span class="s1">edge </span><span class="s0">in </span><span class="s1">g.edges(data=</span><span class="s0">True</span><span class="s1">):</span>
    <span class="s1">print(edge</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s1">print(</span><span class="s2">&quot;##########&quot;</span><span class="s0">, </span><span class="s1">file = fp)</span>



<span class="s3">## 已经算出了所有port 对应的rpc 接下来我们需要判断 RP</span>
<span class="s1">print(</span><span class="s2">'-------更新结果如下---------'</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">g.nodes(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s1">print(node</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s3">#########################此时节点的BPDU更新完毕</span>
<span class="s3">## r RP 每个跟端口有且只有唯一一个</span>
<span class="s1">print(</span><span class="s2">'------选举RootPort-----'</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s1">time.sleep(</span><span class="s4">0.5</span><span class="s1">)</span>

<span class="s0">for </span><span class="s1">swith </span><span class="s0">in </span><span class="s1">switch_list:</span>
    <span class="s0">if </span><span class="s1">swith == target_switch:</span>
        <span class="s0">continue</span>
    <span class="s3">##开始选举</span>
    <span class="s1">rootport = swith.port[</span><span class="s4">0</span><span class="s1">] </span><span class="s3">## 指明第一个端口</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">swith.port:</span>
        <span class="s0">if </span><span class="s1">g.nodes[i][</span><span class="s2">'RPC'</span><span class="s1">] &lt; g.nodes[rootport][</span><span class="s2">'RPC'</span><span class="s1">]:</span>
            <span class="s1">rootport = i</span>
        <span class="s0">elif </span><span class="s1">g.nodes[i][</span><span class="s2">'RPC'</span><span class="s1">] == g.nodes[rootport][</span><span class="s2">'RPC'</span><span class="s1">] :</span>
            <span class="s0">if </span><span class="s1">g.nodes[i][</span><span class="s2">'SBID'</span><span class="s1">] &lt; g.nodes[rootport][</span><span class="s2">'SBID'</span><span class="s1">]:</span>
                <span class="s1">rootport = i</span>
    <span class="s1">g.nodes[rootport][</span><span class="s2">'Port_status'</span><span class="s1">] = </span><span class="s2">'Root Port'</span>

<span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">g.nodes(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s1">print(node</span><span class="s0">, </span><span class="s1">file = fp)</span>

<span class="s3">## 此时已经交换完成了 我们可以用来选举DP 指定端口的选举</span>

<span class="s3">## DP 的选择是根据 路由器之间 为一个网段，每个网段选举出一个指定端口 比较SBID SPID 来进行决定</span>
<span class="s3">## 先比较 RPC</span>
<span class="s1">print(</span><span class="s2">'-----重新计算RPC------'</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s1">time.sleep(</span><span class="s4">0.2</span><span class="s1">)</span>
<span class="s3">#######################################DP</span>


<span class="s3">### 此时不进行切边，我们需要对链路的RPC重新计算</span>
<span class="s0">for </span><span class="s1">switch </span><span class="s0">in </span><span class="s1">switch_list:</span>
    <span class="s1">port_list = switch.port</span>
    <span class="s1">min = </span><span class="s4">99999</span>
    <span class="s0">for </span><span class="s1">port </span><span class="s0">in </span><span class="s1">port_list:</span>
        <span class="s0">if </span><span class="s1">g.nodes[port][</span><span class="s2">'RPC'</span><span class="s1">] &lt; min:</span>
            <span class="s1">min = g.nodes[port][</span><span class="s2">'RPC'</span><span class="s1">]</span>
    <span class="s0">for </span><span class="s1">port </span><span class="s0">in </span><span class="s1">port_list:</span>
        <span class="s1">g.nodes[port][</span><span class="s2">'RPC'</span><span class="s1">] = min</span>
<span class="s1">target_port = target_switch.port</span>
<span class="s0">for </span><span class="s1">switch </span><span class="s0">in </span><span class="s1">switch_list:</span>
    <span class="s0">if </span><span class="s1">switch == target_switch:</span>
        <span class="s0">continue</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">port_list  =switch.port</span>
        <span class="s0">for </span><span class="s1">port </span><span class="s0">in </span><span class="s1">port_list:</span>
            <span class="s1">g.nodes[port][</span><span class="s2">'SPID'</span><span class="s1">] = port</span>
            <span class="s1">g.nodes[port][</span><span class="s2">'SBID'</span><span class="s1">] = switch.number</span>


<span class="s1">print(</span><span class="s2">'-----选举指定端口DP------'</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s3">#对边进行判断</span>
<span class="s1">port_list = target_switch.port </span><span class="s3">#这些端口已经为DP</span>
<span class="s0">for </span><span class="s1">edge </span><span class="s0">in </span><span class="s1">g.edges.data():</span>
    <span class="s0">if </span><span class="s1">edge[</span><span class="s4">0</span><span class="s1">] </span><span class="s0">in </span><span class="s1">port_list </span><span class="s0">or </span><span class="s1">edge[</span><span class="s4">1</span><span class="s1">] </span><span class="s0">in </span><span class="s1">port_list :</span>
        <span class="s3"># 指定端口已经选举</span>
        <span class="s0">continue</span>
    <span class="s0">if</span><span class="s1">(edge[</span><span class="s4">2</span><span class="s1">][</span><span class="s2">'weight'</span><span class="s1">] == </span><span class="s4">0</span><span class="s1">):</span>
        <span class="s0">continue</span>
    <span class="s3">#此时未选举</span>
    <span class="s0">if </span><span class="s1">g.nodes[edge[</span><span class="s4">0</span><span class="s1">]][</span><span class="s2">'RPC'</span><span class="s1">] &lt; g.nodes[edge[</span><span class="s4">1</span><span class="s1">]][</span><span class="s2">'RPC'</span><span class="s1">]:</span>
        <span class="s1">g.nodes[edge[</span><span class="s4">0</span><span class="s1">]][</span><span class="s2">'Port_status'</span><span class="s1">] = </span><span class="s2">'Designated'</span>
    <span class="s0">elif </span><span class="s1">g.nodes[edge[</span><span class="s4">0</span><span class="s1">]][</span><span class="s2">'RPC'</span><span class="s1">] &gt; g.nodes[edge[</span><span class="s4">1</span><span class="s1">]][</span><span class="s2">'RPC'</span><span class="s1">]:</span>
        <span class="s1">g.nodes[edge[</span><span class="s4">1</span><span class="s1">]][</span><span class="s2">'Port_status'</span><span class="s1">] = </span><span class="s2">'Designated'</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s3">#对比SBID</span>
        <span class="s0">if </span><span class="s1">g.nodes[edge[</span><span class="s4">0</span><span class="s1">]][</span><span class="s2">'SBID'</span><span class="s1">] &lt; g.nodes[edge[</span><span class="s4">1</span><span class="s1">]][</span><span class="s2">'SBID'</span><span class="s1">]:</span>
            <span class="s1">g.nodes[edge[</span><span class="s4">0</span><span class="s1">]][</span><span class="s2">'Port_status'</span><span class="s1">] = </span><span class="s2">'Designated'</span>
        <span class="s0">elif </span><span class="s1">g.nodes[edge[</span><span class="s4">0</span><span class="s1">]][</span><span class="s2">'SBID'</span><span class="s1">] &gt; g.nodes[edge[</span><span class="s4">1</span><span class="s1">]][</span><span class="s2">'SBID'</span><span class="s1">]:</span>
            <span class="s1">g.nodes[edge[</span><span class="s4">1</span><span class="s1">]][</span><span class="s2">'Port_status'</span><span class="s1">] = </span><span class="s2">'Designated'</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">if </span><span class="s1">g.nodes[edge[</span><span class="s4">0</span><span class="s1">]][</span><span class="s2">'SPID'</span><span class="s1">] &lt; g.nodes[edge[</span><span class="s4">1</span><span class="s1">]][</span><span class="s2">'SPID'</span><span class="s1">]:</span>
                <span class="s1">g.nodes[edge[</span><span class="s4">0</span><span class="s1">]][</span><span class="s2">'Port_status'</span><span class="s1">] = </span><span class="s2">'Designated'</span>
            <span class="s0">elif </span><span class="s1">g.nodes[edge[</span><span class="s4">0</span><span class="s1">]][</span><span class="s2">'SPID'</span><span class="s1">] &gt; g.nodes[edge[</span><span class="s4">1</span><span class="s1">]][</span><span class="s2">'SPID'</span><span class="s1">]:</span>
                <span class="s1">g.nodes[edge[</span><span class="s4">1</span><span class="s1">]][</span><span class="s2">'Port_status'</span><span class="s1">] = </span><span class="s2">'Designated'</span>

<span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">g.nodes(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s1">print(node</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s3">## 端口更新成功</span>
<span class="s1">print(</span><span class="s2">&quot;端口状态更新成功&quot;</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s1">print(</span><span class="s2">&quot;-------选举堵塞AP端口------&quot;</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s1">time.sleep(</span><span class="s4">0.5</span><span class="s1">)</span>
<span class="s1">apPort_list = list()</span>
<span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">g.nodes.data():</span>
    <span class="s0">if </span><span class="s1">node[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'Port_status'</span><span class="s1">] == </span><span class="s2">'None' </span><span class="s1">:</span>
        <span class="s3">##此时为AP</span>
        <span class="s1">node[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'Port_status'</span><span class="s1">] = </span><span class="s2">'AP'</span>
        <span class="s1">apPort_list.append(node[</span><span class="s4">0</span><span class="s1">])</span>
<span class="s1">print(</span><span class="s2">'-------打印最终结果-------'</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">g.nodes(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s1">print(node</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s1">print(</span><span class="s2">&quot;##3种端口状态及根桥更新完毕##&quot;</span><span class="s0">, </span><span class="s1">file = fp)</span>


<span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">g.nodes(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s1">print(node)</span>
<span class="s1">fp2 = open(</span><span class="s2">'/Users/yewen/Desktop/2023毕业设计/code/STP/data_test/role.txt'</span><span class="s0">, </span><span class="s2">&quot;w&quot;</span><span class="s1">)</span>
<span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">g.nodes(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s1">print(str(node[</span><span class="s4">0</span><span class="s1">])+ </span><span class="s2">&quot; &quot; </span><span class="s1">+ </span><span class="s2">&quot;role: &quot; </span><span class="s1">+ node[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">'Port_status'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">file = fp2)</span>
<span class="s1">fp2.close()</span>

<span class="s0">for </span><span class="s1">edge </span><span class="s0">in </span><span class="s1">g.edges(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s1">print(edge)</span>

<span class="s1">edge_remove = list()</span>
<span class="s0">for </span><span class="s1">edge </span><span class="s0">in </span><span class="s1">g.edges(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s1">port1 = edge[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">port2 = edge[</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s0">if </span><span class="s1">edge[</span><span class="s4">2</span><span class="s1">][</span><span class="s2">'weight'</span><span class="s1">] == </span><span class="s4">0</span><span class="s1">:</span>
        <span class="s0">continue</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">if </span><span class="s1">port1 </span><span class="s0">in </span><span class="s1">apPort_list </span><span class="s0">or </span><span class="s1">port2 </span><span class="s0">in </span><span class="s1">apPort_list:</span>
            <span class="s1">edge_remove.append(edge)</span>

<span class="s0">for </span><span class="s1">edge </span><span class="s0">in </span><span class="s1">edge_remove:</span>
    <span class="s1">g.remove_edge(edge[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">edge[</span><span class="s4">1</span><span class="s1">])</span>

<span class="s1">print(</span><span class="s2">'开始计算MAC转发表'</span><span class="s1">)</span>

<span class="s1">fwdTable_list = list()</span>
<span class="s1">pc_list = dict()</span>
<span class="s1">allPc = list()</span>
<span class="s1">mac_node_map = dict()</span>
<span class="s0">for </span><span class="s1">switch </span><span class="s0">in </span><span class="s1">switch_list:</span>
    <span class="s1">fwdTable_list.append(fwd_table(switch.switch_name))</span>
    <span class="s1">str1 = str(switch.pc_mac)</span>
    <span class="s1">list1 = str1.split(</span><span class="s2">','</span><span class="s1">)</span>
    <span class="s1">list1 = [str(i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">list1]</span>
    <span class="s3">## 现在添加PC节点</span>
    <span class="s1">pc_list[switch.switch_name] = list1</span>
    <span class="s0">for </span><span class="s1">pc </span><span class="s0">in </span><span class="s1">list1:</span>
        <span class="s1">allPc.append(pc)</span>
        <span class="s1">mac = pc</span>
        <span class="s1">pc = pc[</span><span class="s4">3</span><span class="s1">:]</span>
        <span class="s1">mac_node_map[mac] = </span><span class="s2">'pc' </span><span class="s1">+ str(pc)</span>
        <span class="s1">g.add_node(</span><span class="s2">'pc' </span><span class="s1">+ str(pc)</span><span class="s0">, </span><span class="s1">PRC = -</span><span class="s4">1</span><span class="s0">, </span><span class="s1">SBID = -</span><span class="s4">1</span><span class="s0">, </span><span class="s1">SPID = -</span><span class="s4">1</span><span class="s0">, </span><span class="s1">Port_status = </span><span class="s2">'PC' </span><span class="s1">)</span>
        <span class="s1">g.add_edge(switch.switch_name</span><span class="s0">, </span><span class="s2">'pc' </span><span class="s1">+ str(pc)</span><span class="s0">, </span><span class="s1">weight = </span><span class="s4">0</span><span class="s1">)</span>

<span class="s1">print(</span><span class="s2">&quot;----------增加PC节点后------------&quot;</span><span class="s1">)</span>

<span class="s0">for </span><span class="s1">edge </span><span class="s0">in </span><span class="s1">g.edges(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s1">print(edge)</span>

<span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">g.nodes(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s1">print(node)</span>

<span class="s3">#index MAC-地址——————————————VLANID----------PORT</span>

<span class="s0">for </span><span class="s1">switch </span><span class="s0">in </span><span class="s1">fwdTable_list:</span>
    <span class="s1">print(switch.name + </span><span class="s2">&quot;路由表项&quot;</span><span class="s1">)</span>
    <span class="s1">switch_name = switch.name</span>
    <span class="s3">##添加自己的路由表项</span>
    <span class="s1">port_list = pc_list[switch_name]</span>
    <span class="s0">for </span><span class="s1">pc </span><span class="s0">in </span><span class="s1">port_list:</span>
        <span class="s3">#添加自己的路由表项</span>
        <span class="s1">mac = pc</span>
        <span class="s1">node = mac_node_map[mac]</span>
        <span class="s1">index = [mac</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">node]</span>
        <span class="s1">switch.fwd_index.append(index)</span>
        <span class="s1">print(index)</span>

    <span class="s0">for </span><span class="s1">pc_des </span><span class="s0">in </span><span class="s1">allPc:</span>
        <span class="s0">if </span><span class="s1">pc_des </span><span class="s0">in </span><span class="s1">port_list:</span>
            <span class="s0">continue</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">destination = mac_node_map[pc_des]</span>
            <span class="s1">path1 = path(switch_name</span><span class="s0">, </span><span class="s1">destination)</span>
            <span class="s1">index = [pc_des</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">path1[</span><span class="s4">1</span><span class="s1">]]</span>
            <span class="s1">switch.fwd_index.append(index)</span>
            <span class="s1">print(index)</span>










<span class="s0">for </span><span class="s1">edge </span><span class="s0">in </span><span class="s1">edge_remove:</span>
    <span class="s1">g.add_edge(edge[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">edge[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">weight = edge[</span><span class="s4">2</span><span class="s1">][</span><span class="s2">'weight'</span><span class="s1">])</span>

<span class="s1">print(</span><span class="s2">'---------MAC转发表添加完毕-------------'</span><span class="s1">)</span>




<span class="s3">##开始画图：</span>

<span class="s1">print(</span><span class="s2">'-----拓扑图更新-----'</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s1">icons = {</span>
<span class="s2">&quot;switch&quot;</span><span class="s1">: </span><span class="s2">'/Users/yewen/Desktop/2023毕业设计/code/switch_node.png'</span>
<span class="s1">}</span>
<span class="s3"># Load images</span>
<span class="s1">images = {k: PIL.Image.open(fname) </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">fname </span><span class="s0">in </span><span class="s1">icons.items()}</span>


<span class="s1">port_ap = list()</span>
<span class="s1">macALL = list()</span>
<span class="s0">for </span><span class="s1">switch </span><span class="s0">in </span><span class="s1">switch_list:</span>
    <span class="s1">port_list = switch.port</span>
    <span class="s1">str1 = str(switch.pc_mac)</span>
    <span class="s1">list1 = str1.split(</span><span class="s2">','</span><span class="s1">)</span>
    <span class="s1">list1 = [str(i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">list1]</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">list1:</span>
        <span class="s1">macALL.append(i)</span>
    <span class="s1">G.add_node(switch.switch_name</span><span class="s0">, </span><span class="s1">BID=switch.number</span><span class="s0">, </span><span class="s1">Port_status=</span><span class="s2">'Switch'</span><span class="s0">, </span><span class="s1">image=images[</span><span class="s2">'switch'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fwd_mac = list1</span><span class="s0">, </span><span class="s1">fwding = list())</span>
    <span class="s0">for </span><span class="s1">port </span><span class="s0">in </span><span class="s1">port_list:</span>
        <span class="s0">if </span><span class="s1">g.nodes[port][</span><span class="s2">'Port_status'</span><span class="s1">] ==</span><span class="s2">'AP'</span><span class="s1">:</span>
            <span class="s1">G.add_node(switch.switch_name</span><span class="s0">, </span><span class="s1">BID=switch.number</span><span class="s0">, </span><span class="s1">Port_status=</span><span class="s2">'Switch_AP'</span><span class="s0">, </span><span class="s1">image=images[</span><span class="s2">'switch'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fwd_mac= list1</span><span class="s0">, </span><span class="s1">fwding = list())</span>
            <span class="s1">port_ap.append(port)</span>



<span class="s0">for </span><span class="s1">edge </span><span class="s0">in </span><span class="s1">g.edges(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s0">if </span><span class="s1">edge[</span><span class="s4">2</span><span class="s1">][</span><span class="s2">'weight'</span><span class="s1">] == </span><span class="s4">0 </span><span class="s1">:</span>
        <span class="s0">continue</span>
    <span class="s1">weight = edge[</span><span class="s4">2</span><span class="s1">][</span><span class="s2">'weight'</span><span class="s1">]</span>
    <span class="s1">flag = </span><span class="s4">0</span>
    <span class="s0">if </span><span class="s1">g.nodes[edge[</span><span class="s4">0</span><span class="s1">]][</span><span class="s2">'Port_status'</span><span class="s1">] == </span><span class="s2">'AP' </span><span class="s0">or </span><span class="s1">g.nodes[edge[</span><span class="s4">1</span><span class="s1">]][</span><span class="s2">'Port_status'</span><span class="s1">] == </span><span class="s2">'AP'</span><span class="s1">:</span>
        <span class="s1">flag = </span><span class="s4">1</span>
    <span class="s1">pair = list()</span>
    <span class="s1">pair_name = list()</span>
    <span class="s1">pair.append(edge[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">pair.append(edge[</span><span class="s4">1</span><span class="s1">])</span>
    <span class="s3">##寻找</span>


    <span class="s0">for </span><span class="s1">port </span><span class="s0">in </span><span class="s1">pair:</span>
        <span class="s0">for </span><span class="s1">switch </span><span class="s0">in </span><span class="s1">switch_list:</span>
            <span class="s0">if </span><span class="s1">port </span><span class="s0">in </span><span class="s1">switch.port:</span>
                <span class="s1">pair_name.append(switch.switch_name)</span>
    <span class="s3">##找到了</span>
    <span class="s1">G.add_edge(pair_name[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">pair_name[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">weight = weight</span><span class="s0">, </span><span class="s1">AP = </span><span class="s2">'false'</span><span class="s0">, </span><span class="s1">color = </span><span class="s2">'blue'</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">flag == </span><span class="s4">1</span><span class="s1">:</span>
        <span class="s1">G[pair_name[</span><span class="s4">0</span><span class="s1">]][pair_name[</span><span class="s4">1</span><span class="s1">]][</span><span class="s2">'AP'</span><span class="s1">] = </span><span class="s2">'true'</span>


<span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">G.nodes(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s1">print(node)</span>
<span class="s0">for </span><span class="s1">edge </span><span class="s0">in </span><span class="s1">G.edges(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s1">print(edge)</span>
<span class="s3">##开始学习MAC表</span>


<span class="s3">## 未每个switch分配mac学习表</span>

<span class="s1">print(</span><span class="s2">&quot;########&quot;</span><span class="s0">, </span><span class="s1">file = fp)</span>
<span class="s1">edge_list_red = list()</span>
<span class="s1">edge_list_blue = list()</span>
<span class="s3">## blue 为存储AP的端口</span>
<span class="s0">for </span><span class="s1">edge </span><span class="s0">in </span><span class="s1">G.edges(data = </span><span class="s0">True</span><span class="s1">):</span>
    <span class="s0">if </span><span class="s1">edge[</span><span class="s4">2</span><span class="s1">][</span><span class="s2">'AP'</span><span class="s1">] == </span><span class="s2">'false' </span><span class="s1">:</span>
        <span class="s1">edge_list_red.append((edge[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span><span class="s1">edge[</span><span class="s4">1</span><span class="s1">]))</span>
    <span class="s0">if </span><span class="s1">edge[</span><span class="s4">2</span><span class="s1">][</span><span class="s2">'AP'</span><span class="s1">] == </span><span class="s2">'true' </span><span class="s1">:</span>
        <span class="s1">edge_list_blue.append((edge[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">edge[</span><span class="s4">1</span><span class="s1">]))</span>
    <span class="s1">print(edge</span><span class="s0">, </span><span class="s1">file = fp)</span>

<span class="s3">## G 中存储着对应的switch节点</span>
<span class="s3">## switch_list 存储对应接口的具体消息</span>


<span class="s1">print(</span><span class="s2">&quot;-------节点分类-----&quot;</span><span class="s1">)</span>


<span class="s1">fp1 = open(</span><span class="s2">'/Users/yewen/Desktop/2023毕业设计/code/STP/data_test/mac_table.txt'</span><span class="s0">, </span><span class="s2">&quot;w&quot;</span><span class="s1">)</span>
<span class="s0">for </span><span class="s1">switch </span><span class="s0">in </span><span class="s1">fwdTable_list:</span>
    <span class="s1">list_fwd = switch.fwd_index</span>
    <span class="s1">n = len(list_fwd)</span>
    <span class="s1">print(switch.name + </span><span class="s2">&quot; MAC表如下：&quot;</span><span class="s0">, </span><span class="s1">file = fp1)</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(n):</span>
        <span class="s1">print(list_fwd[i]</span><span class="s0">, </span><span class="s1">file = fp1)</span>
    <span class="s1">print(</span><span class="s2">&quot;   &quot;</span><span class="s0">, </span><span class="s1">file = fp1)</span>
<span class="s1">fp1.close()</span>

<span class="s3">###开始画图</span>

<span class="s1">pos = nx.spring_layout(G</span><span class="s0">, </span><span class="s1">seed=</span><span class="s4">1734289230</span><span class="s1">)</span>
<span class="s1">fig</span><span class="s0">, </span><span class="s1">ax = plt.subplots()</span>



<span class="s3">##对线进行处理</span>
<span class="s1">nx.draw_networkx_edges(</span>
    <span class="s1">G</span><span class="s0">,</span>
    <span class="s1">pos=pos</span><span class="s0">,</span>
    <span class="s1">edgelist = edge_list_red</span><span class="s0">,</span>
    <span class="s1">ax=ax</span><span class="s0">,</span>
    <span class="s1">arrows=</span><span class="s0">True,</span>
    <span class="s1">arrowstyle=</span><span class="s2">&quot;-&quot;</span><span class="s0">,</span>
    <span class="s1">min_source_margin=</span><span class="s4">15</span><span class="s0">,</span>
    <span class="s1">min_target_margin=</span><span class="s4">15</span><span class="s0">,</span>
    <span class="s1">edge_color=</span><span class="s2">&quot;tab:red&quot;</span><span class="s0">,</span>

<span class="s1">)</span>
<span class="s1">nx.draw_networkx_edges(</span>
    <span class="s1">G</span><span class="s0">,</span>
    <span class="s1">pos=pos</span><span class="s0">,</span>
    <span class="s1">edgelist = edge_list_blue</span><span class="s0">,</span>
    <span class="s1">ax=ax</span><span class="s0">,</span>
    <span class="s1">arrows=</span><span class="s0">True,</span>
    <span class="s1">arrowstyle=</span><span class="s2">&quot;]-[&quot;</span><span class="s0">,</span>
    <span class="s1">min_source_margin=</span><span class="s4">15</span><span class="s0">,</span>
    <span class="s1">min_target_margin=</span><span class="s4">15</span><span class="s0">,</span>
    <span class="s1">edge_color=</span><span class="s2">&quot;tab:blue&quot;</span><span class="s0">,</span>
<span class="s1">)</span>

<span class="s3">#设置字体为楷体</span>



<span class="s1">plt.title(</span><span class="s2">&quot;STP result&quot;</span><span class="s1">)</span>
<span class="s1">tr_figure = ax.transData.transform</span>
<span class="s1">tr_axes = fig.transFigure.inverted().transform</span>
<span class="s1">icon_size = (ax.get_xlim()[</span><span class="s4">1</span><span class="s1">] - ax.get_xlim()[</span><span class="s4">0</span><span class="s1">]) * </span><span class="s4">0.025</span>
<span class="s1">icon_center = icon_size / </span><span class="s4">2.0</span>
<span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">G.nodes:</span>
    <span class="s1">xf</span><span class="s0">, </span><span class="s1">yf = tr_figure(pos[n])</span>
    <span class="s1">xa</span><span class="s0">, </span><span class="s1">ya = tr_axes((xf</span><span class="s0">, </span><span class="s1">yf))</span>
    <span class="s3"># get overlapped axes and plot icon</span>
    <span class="s1">a = plt.axes([xa - icon_center</span><span class="s0">, </span><span class="s1">ya - icon_center</span><span class="s0">, </span><span class="s1">icon_size</span><span class="s0">, </span><span class="s1">icon_size])</span>
    <span class="s1">a.imshow(G.nodes[n][</span><span class="s2">&quot;image&quot;</span><span class="s1">]</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">a.axis(</span><span class="s2">&quot;off&quot;</span><span class="s1">)</span>
    <span class="s1">plt.title(n)</span>
<span class="s1">fp.close()</span>
<span class="s1">plt.savefig(</span><span class="s2">'/Users/yewen/Desktop/2023毕业设计/code/STP/data_test/stp.png'</span><span class="s1">)</span>
<span class="s1">plt.show()</span>


</pre>
</body>
</html>